async function gatherDesignDetails(){const e=[],t=document.querySelectorAll(".design-row");return t.forEach(t=>{const n=t.querySelector("td:first-child"),r=n?n.textContent:"Unnamed Design",a=t.dataset.designId,s=t.querySelector(".design-preview"),i=s?s.src:null;if(!a)return void console.error("Design ID is missing for row:",t);const o={},d=t.querySelectorAll(".size-range-group");d.forEach(e=>{const t=e.querySelector(".size-range-select"),n=e.querySelector(".quantity-input");if(t&&n){const e=t.value,r=Number.parseInt(n.value)||0;r>0&&(o[e]=(o[e]||0)+r)}});const l=t.querySelector(".silicon-grip-checkbox"),c=!!l&&l.checked;Object.keys(o).length>0&&e.push({id:a,name:r,sizes:o,siliconGrip:c,imageUrl:i})}),e}async function saveOrderToSupabase(e){showLoading();try{const{data:{user:t},error:n}=await supabase.auth.getUser();if(n)throw hideLoading(),n;if(!t)throw hideLoading(),new Error("No authenticated user found");let r=0;const a=e.designs.map(e=>{const t=Object.values(e.sizes).reduce((e,t)=>e+t,0);return r+=t,{design_id:e.id,design_name:e.name||e.custom_name||"Unnamed Design",sizes:e.sizes,item_total_quantity:t,silicon_grip:e.siliconGrip,image_url:e.imageUrl}}),s={user_id:t.id,full_name:e.fullName,email_order:e.emailOrder,total_quantity:r,order_items:a},{data:i,error:o}=await supabase.from("user_orders").insert([s]).select();if(o)throw hideLoading(),o;const d=a.map(async e=>{if(!e.design_id)return void console.error("Design ID is undefined:",e);const{data:t,error:n}=await supabase.from("user_files").select("order_placed").eq("id",e.design_id).single();if(n)return void console.error(`Error fetching order_placed for design ${e.design_id}:`,n);const r=(t&&t.order_placed||0)+1,{error:a}=await supabase.from("user_files").update({order_placed:r}).eq("id",e.design_id);a?console.error(`Error updating order_placed for design ${e.design_id}:`,a):console.log(`Successfully updated order_placed for design ${e.design_id} to ${r}`)});return await Promise.all(d),console.log("Order saved successfully:",i),hideLoading(),i}catch(e){throw console.error("Error saving order:",e),hideLoading(),e}}document.addEventListener("DOMContentLoaded",()=>{async function e(){const{data:e,error:t}=await supabase.from("user_files").select("id, design_name, name, custom_name, design_metadata, created_at, short_code").order("created_at",{ascending:!1});return t?(console.error("Error fetching designs:",t),[]):e.filter(e=>null!==e.design_name||null!==e.custom_name)}function t(){h.classList.add("active"),r()}function n(){h.classList.remove("active")}async function r(){const t=await e();_.innerHTML="",t.forEach(e=>{const t=a(e);_.appendChild(t)})}function a(e){const t=document.createElement("div");t.className="design-item",t.dataset.designId=e.id;const n=`${SUPABASE_URL}/storage/v1/object/public/public-bucket/${e.name}`,r=new Date(e.created_at).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}),a=e.custom_name&&""!==e.custom_name.trim()?e.custom_name:e.design_name;t.innerHTML=`\n                <div class="design-preview">\n                    <img src="${n}" alt="${a}" class="design-thumbnail">\n                </div>\n                <div class="design-info">\n                    <h3>${a}</h3>\n                    <p>Created on ${r}</p>\n                </div>\n                <button class="select-button">Select</button>\n            `,t.addEventListener("click",()=>s(e));const i=t.querySelector(".select-button");return i.addEventListener("click",t=>{t.stopPropagation(),s(e)}),t}function s(e){i(e.id),n()}async function i(e){const{data:t,error:n}=await supabase.from("user_files").select("*").eq("id",e).single();if(n)return void console.error("Error fetching design:",n);const r=t.custom_name&&""!==t.custom_name.trim()?t.custom_name:t.design_name,a=document.createElement("tr");a.className="design-row",a.dataset.designId=t.id,a.innerHTML=`\n            <td>${r}</td>\n            <td>\n                <div class="preview-box">\n                    <img src="${SUPABASE_URL}/storage/v1/object/public/public-bucket/${t.name}" alt="${t.design_name} Preview" class="design-preview">\n                </div>\n            </td>\n            <td>\n                <div class="size-ranges">\n                    ${o(a).outerHTML}\n                </div>\n            </td>\n            <td class="silicon-grip">\n                <input type="checkbox" class="silicon-grip-checkbox">\n            </td>\n            <td class="total-quantity">0</td>\n            <td>\n                <button class="remove-design">\n                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n                        <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                    </svg>\n                </button>\n            </td>\n        `,w.appendChild(a),l(a),g(a),p()}function o(e){const t=document.createElement("div");t.className="size-range-group";const n=d(e),r=n[0]||"";t.innerHTML=`\n            <select class="size-range-select">\n                ${n.map(e=>`<option value="${e}">${e}</option>`).join("")}\n            </select>\n            <input type="number" class="quantity-input" min="1" value="0">\n            <button class="add-size-range">\n                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n                    <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                </svg>\n            </button>\n            <button class="remove-size-range">\n                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n                    <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                </svg>\n            </button>\n        `;const a=t.querySelector(".size-range-select");return a&&(a.value=r),t}function d(e){const t=["27/30","31/34","35/38","39/42","43/46","47/50"],n=Array.from(e.querySelectorAll(".size-range-select")).map(e=>e.value);return t.filter(e=>!n.includes(e))}function l(e){e.addEventListener("click",t=>{t.target.closest(".add-size-range")?u(e):t.target.closest(".remove-size-range")?m(t.target.closest(".remove-size-range")):t.target.closest(".remove-design")&&v(e)}),e.addEventListener("input",e=>{e.target.classList.contains("quantity-input")&&p()}),e.addEventListener("change",t=>{t.target.classList.contains("size-range-select")&&c(e)})}function c(e){const t=d(e);e.querySelectorAll(".size-range-select").forEach(e=>{const n=e.value,r=t.concat(n).filter((e,t,n)=>n.indexOf(e)===t);e.innerHTML=r.map(e=>`<option value="${e}">${e}</option>`).join(""),e.value=n})}function u(e){const t=e.querySelector(".size-ranges"),n=d(e);if(n.length>0){const n=o(e);t.appendChild(n),c(e),p()}else window.translatedAlert("all_sizes_added")}function g(e){const t=e.querySelector(".size-ranges");t.innerHTML="";const n=o(e);t.appendChild(n)}function m(e){const t=e.closest(".size-range-group"),n=t.closest(".design-row"),r=t.parentElement;r.children.length>1&&(t.remove(),c(n),p())}function v(e){e.remove(),p()}function p(){const e=document.querySelectorAll(".design-row");let t=0;e.forEach(e=>{const n=Array.from(e.querySelectorAll(".quantity-input")).map(e=>parseInt(e.value)||0),r=n.reduce((e,t)=>e+t,0);e.querySelector(".total-quantity").textContent=r,t+=r}),b.textContent=t}const f=document.getElementById("add-design-button"),h=document.getElementById("design-select-modal"),y=document.querySelector(".close-modal"),_=document.querySelector(".design-list"),w=document.getElementById("order-table-body"),b=document.getElementById("grand-total");f.addEventListener("click",t),y.addEventListener("click",n),h.addEventListener("click",e=>{e.target===h&&n()}),document.addEventListener("input",e=>{e.target.classList.contains("quantity-input")&&(e.target.value=e.target.value.replace(/[^0-9]/g,""),e.target.value.startsWith("0")&&(e.target.value=e.target.value.substring(1)),p())})}),document.addEventListener("DOMContentLoaded",async()=>{function e(e){return e.includes("@")&&e.includes(".")}function t(e,t){e&&e.addEventListener("input",n=>{n.target.value=n.target.value.replace(t,""),r(e)})}function n(){const e=navigator.language||navigator.userLanguage;return"fr"===e.substring(0,2)?"fr":"en"}function r(t){if(!t)return;const r=t.parentElement.querySelector(".error-message");if(!r)return;const a=n();t.required&&!t.value.trim()?(t.classList.add("error"),r.innerHTML=`<span data-en="${t.name||"This field"} is required." data-fr="${t.name||"Ce champ"} est obligatoire."></span>`):"email_order"!==t.id||e(t.value)?"phone"!==t.id||/^\d{7,15}$/.test(t.value.replace(/\D/g,""))?(t.classList.remove("error"),r.textContent=""):(t.classList.add("error"),r.innerHTML='<span data-en="Please enter a valid phone number." data-fr="Veuillez entrer un numéro de téléphone valide."></span>'):(t.classList.add("error"),r.innerHTML='<span data-en="Please enter a valid email address." data-fr="Veuillez entrer une adresse e-mail valide."></span>'),r.firstChild&&(r.firstChild.textContent=r.firstChild.getAttribute(`data-${a}`))}async function a(){try{const{data:{user:e}}=await supabase.auth.getUser();if(!e)throw new Error("No authenticated user found");const{data:t,error:n}=await supabase.from("profiles").select("*").eq("user_id",e.id).single();if(n)throw n;t&&(d.value=t.full_name||"",l.value=t.club_name||"",c.value=t.email_order||"",u.value=t.phone||"",g.value=t.address_line1||"",m.value=t.city||"",v.value=t.zip_code||"",p.value=t.state||"",f.value=t.country||"")}catch(e){console.error("Error fetching user data:",e)}}async function s(){const{data:{user:e}}=await supabase.auth.getUser();if(!e)throw new Error("No authenticated user found");const t={user_id:e.id,full_name:d.value.trim(),email:e.email,email_order:c.value.trim(),phone:u.value.trim(),club_name:l.value.trim(),address_line1:g.value.trim(),city:m.value.trim(),state:p.value.trim(),zip_code:v.value.trim(),country:f.value.trim()},{error:n}=await supabase.from("profiles").upsert(t);if(n)throw n}async function i(e){e.preventDefault(),_.forEach(r);const t=_.some(e=>e.classList.contains("error"));if(t)return void window.translatedAlert("form_errors");const n=y?Number.parseInt(y.textContent):0;if(n<0)window.translatedAlert("minimum_quantity_error");else try{await s();const e=await gatherDesignDetails();if(0===e.length)return void window.translatedAlert("no_designs_in_order");const t={fullName:d.value.trim(),emailOrder:c.value.trim(),designs:e},n=await saveOrderToSupabase(t);console.log("Order placed successfully:",n),window.translatedAlert("order_placed_success"),setTimeout(()=>{window.location.reload()},3e3)}catch(e){console.error("Error submitting order:",e),window.translatedAlert("order_placement_error")}}function o(){const e=document.querySelectorAll(".design-row");let t=0;e.forEach(e=>{const n=Array.from(e.querySelectorAll(".quantity-input")).map(e=>Number.parseInt(e.value)||0),r=n.reduce((e,t)=>e+t,0),a=e.querySelector(".total-quantity");a&&(a.textContent=r),t+=r}),y&&(y.textContent=t)}const d=document.getElementById("fullName"),l=document.getElementById("clubName"),c=document.getElementById("email_order"),u=document.getElementById("phone"),g=document.getElementById("address"),m=document.getElementById("city"),v=document.getElementById("zipCode"),p=document.getElementById("state"),f=document.getElementById("country"),h=document.querySelector(".place-order-button"),y=document.getElementById("grand-total"),_=[d,l,c,u,g,m,v,p,f];t(d,/[^A-Za-z ]/g),t(l,/[^A-Za-z0-9 ]/g),t(u,/[^0-9-+() ]/g),t(m,/[^A-Za-z ]/g),t(v,/[^0-9-]/g),t(p,/[^A-Za-z ]/g),t(f,/[^A-Za-z ]/g),h&&h.addEventListener("click",i),document.addEventListener("input",e=>{e.target.classList.contains("quantity-input")&&(e.target.value=e.target.value.replace(/[^0-9]/g,""),e.target.value.startsWith("0")&&(e.target.value=e.target.value.substring(1)),o())}),a()});